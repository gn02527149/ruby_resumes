<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="vSDDtsjOSV6eEot9nm5GxGLmCH1Tir3BPe0UyUp9">
    <title>好礼有狗赞，精采刮出来</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="header">
        <div class="middlebox">
            <div class="logo">
                <img class="web" src="images/logo.png">
                <span class="mobile">全民刮刮乐</span>
            </div>
            <p class="hello">欢迎您，<span class="account"></span></p>
            <div class="login-div">
                <img class="web" src="images/login.png">
                <span class="mobile">登入</span>
            </div>
            <div class="logout-div" style="display:none;">
                <img class="web" src="images/logout.png">
                <span class="mobile">登出</span>
            </div>

        </div>
    </div>
    <img class="banner web" src="images/banner.png">
    <img class="banner mobile" src="images/m-banner.png">
    <div class="middlebox">

        <div class="cardbox" id="cardBox">
            <div class="card">
                <div class="reduxBox">
                    <div id="mask_img_bg">

                        <img src="images/prizeVip3.png" />
                    </div>
                    <img id="redux" src="images/cardTop.png" />
                </div>
                <div class="btns">
                    <a class="nextCard" id="continue-btn"></a>
                    <a class="redemption" id="contact-kf-btn"></a>
                </div>
            </div>



            <div class="list">
                <div class="title">
                    <li class="active" data-id="1">人来人往</li>
                    <li id="my-records" data-id="2">中奖纪录</li>
                </div>
                <div class="boxs">
                    <div class="allbox" id="marquee2">
                        <ul class="marqueebox">
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 157******760 刮中 888 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 135******584 刮中 1188 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 135******731 刮中 588 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 189******637 刮中 488 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******087 刮中 288 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 135******713 刮中 988 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******326 刮中 1388 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******221 刮中 38 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******258 刮中 1188 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******112 刮中 38 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 150******803 刮中 688 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******693 刮中 588 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 131******111 刮中 38 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******111 刮中 38 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******114 刮中 38 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 138******234 刮中 1588 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 157******655 刮中 188 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 153******951 刮中 788 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 157******280 刮中 88 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 138******505 刮中 1688 元
                            </li>
                            <li>
                                <img src="images/listdot.png" alt="">
                                <span class="num"></span> 恭喜 132******113 刮中 38 元
                            </li>
                        </ul>
                    </div>
                    <div class="allbox" id="reward" style="display: none;">

                        <table>
                            <tr class="tableTitle">
                                <td>请先登录</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="service" id="service">
        <div class="middlebox">
            <div class="service_info">
                <div class="info info_l">
                    <a class="web" href="http://shang.qq.com/email/stop/email_stop.html?qq=qq123&sig=a1c657365db7e82805ea4b2351081fc3ebcde159f8ae49b1&tttt=1" target="_blank">
                        <p><span class="qqName">qq123</span></p>
                        <img class="QR-qq" src="images/QQ-qrcode.png" alt="" />
                    </a>
                    <a class="mobile" href="http://qm.qq.com/cgi-bin/qm/qr?k=Ts_4qDzzAK6p-5TgEQuFUc_YtGGOHD8u" target="_blank">
                        <p><span class="qqName">qq123</span></p>
                        <img class="QR-qq" src="images/QQ-qrcode.png" alt="" />
                    </a>
                </div>
                <div class="info info_r" id="copy" data-clipboard-target="#wechatName">
                    <a>
                        <p class="web"><span class="wechatName">wechat456</span></p>
                        <p class="mobile"><span class="wechatName" id="wechatName">wechat456</span></p>
                        <img class="QR-wechat" src="images/wechat-qrcode.png" alt="" />
                    </a>
                </div>
            </div>
        </div>
        <div class="serviceBg web" alt=""></div>
    </div>



    <div class="footer">
        <div class="copyright web"><img src="images/copyright.png"></div>
        <div class="copyright mobile"><img src="images/m-copyright.png"></div>
    </div>



    <div class="mask2"></div>


    <div class="login-show">
        <img class="hint-img" src="images/loginbg.png" />
        <input type="text" name="cellphone_num" placeholder="请输入领奖手机号码" />
        <a class="close">X</a>
        <a id="login-btn" class="btn">点击验证</a>
    </div>



    <div class="caveat-show">
        <p>建议您将屏幕横置<br>以获取最佳的视觉效果</p>
    </div>


    <div class="reward-show">
        <a class="close">X</a>
        <h2>中奖查询</h2>
        <div class="info">
            <div id="played_records" class="reward">

            </div>
            <a class="btn">关闭</a>
            <p>本次活动真实有效 劝君莫失良机<br>请在中奖后72小时内联系活动专员进行兑奖
            </p>
        </div>
    </div>


    <div class="wechat-show">
        <a class="close">X</a>
        <p>微信号复制成功<br>马上跳转微信加好友!</p>
        <a class="btn" href="weixin://">好</a>
    </div>


    <div class="loading-show">
        <p>页面处理中，请稍后</p>
    </div>


    <script src="js/jquery.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/jquery.eraser.js"></script>
    <script src="js/Marquee.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>

    <script>
        $(function() {

            var ajax_sent = false,
                logged_in = false,
                account = "",
                is_demo = false,
                last = false,
                done = false;


            $.ajaxSetup({
                headers: {
                    "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content")
                },
                beforeSend: function() {
                    ajax_sent = true;
                    $('.loading-show,.mask2').show();
                },
                error: function(jqXHR) {
                    if (jqXHR.status == '419') {
                        if (confirm("Session 已失效，请重新整理页面.")) {
                            location.reload();
                        }
                    }
                },
                complete: function(jqXHR, textStatus) {
                    ajax_sent = false;
                    $('.loading-show,.mask,.mask2').hide();
                }
            });

            var ww = $(window).width();

            $(window).resize(function() {
                window.location.reload();
                ww = $(window).width();
                if (ww <= 500) {
                    $('#redux').attr("src", "images/m-cardTop.png");
                }
                if (ww < 1000 && ww > 450) {
                    $('.caveat-show,.mask2').show();
                } else {
                    $('.caveat-show,.mask2').hide();
                }
            });



            if (ww <= 500) {
                $('#redux').attr("src", "images/m-cardTop.png");
            }
            if (ww < 1000 && ww > 450) {
                $('.caveat-show,.mask2').show();
            } else {
                $('.caveat-show,.mask2').hide();
            }



            $('.info_r').click(function() {
                if (ww <= 500) {
                    $('.wechat-show,.mask').show();
                } else {
                    return false;
                }
            });


            $('.login-div').click(function() {
                if (logged_in) {
                    if (confirm("您已登录, 是否登出?")) {
                        logout();
                    }
                    return;
                }
                $('.login-show,.mask').fadeIn(300);
                $('input[name="cellphone_num"]').focus();
            });


            $(".mask,.login-show .close").click(function() {
                $(".login-show,.mask").fadeOut(300);
            });


            $(".mask,.hint-show .close,.wechat-show .close").click(function() {
                $(".hint-show,.mask").fadeOut(300);
            });
            $(".hint-show .btn").click(function() {
                $(".hint-show").fadeOut(300);
            });
            $(".mask,.wechat-show .close,.wechat-show .btn").click(function() {
                $(".wechat-show,.mask").fadeOut(300);
            });
            $(".mask,.caveat-show .close,.caveat-show .btn").click(function() {
                $(".caveat-show,.mask").fadeOut(300);
            });


            $('.logout-div').click(function() {
                if (confirm("是否登出?")) {
                    logout();
                }
            });


            $("#login-btn").click(function() {
                if (ajax_sent) {
                    return;
                }

                var cellphone_num = $('input[name="cellphone_num"]').val();
                if (!cellphone_num) {
                    alert('手机号码不能为空');
                    $('input[name="cellphone_num"]').focus();
                    return;
                } else {
                    alert('登录成功');
                    afterLoggedIn(cellphone_num);
                }
            });

            function afterLoggedIn(cellphone_num) {
                logged_in = true;
                account = cellphone_num;
                getImg();
                $(".login-div").hide();
                $(".logout-div").show();
                $(".login-show .close").click();
                $(".account").text(account);
                $(".nav").css("display", "flex");
                $('#redux').css('pointer-events', 'auto');
                $('.list .title li:eq(0)').trigger("click");
            }


            function logout() {
                if (ajax_sent) {
                    return;
                }
                $('#redux').eraser('reset');
                $('#redux').css('pointer-events', 'none');
                $(".nav").hide();
                $(".logout-div").hide();
                $(".login-div").show();
                $(".account").text("");
                $("#contact-kf-btn").hide();
                $("#continue-btn").hide();
                $("#reward").html('<table><tr class="tableTitle"><td>请先登录</td></tr></table>');
                alert('登出成功');
            }


            function getImg() {

                if (ajax_sent) {
                    setTimeout(getImg, 50);
                    return;
                }
                $("#contact-kf-btn").hide();
                $("#continue-btn").hide();
                $('#redux').eraser('reset');
                $.ajax({
                    url: is_demo ? "http://localhost:8888/game/demo" : "http://localhost:8888/game/play",
                    type: "post",
                    dataType: "json",
                    success: function(res) {
                        if (res.error == "000") {
                            $("#mask_img_bg img").attr("src", res.data);
                            $(".hint-show .hint-img").attr("src", res.data);
                            last = res.last;
                        } else if (res.msg) {
                            console.log(res.msg);
                        } else {
                            alert("发生未知的错误");
                        }
                    }
                });
            }



            var click_event = jQuery.fn.tap ? "tap" : "click";
            $(".reduxBox").on(click_event, function(e) {
                if (ajax_sent) {
                    alert("页面处理中，请稍后再试");
                    return;
                }
                if (!(logged_in || is_demo)) {
                    $('.login-div').click();
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                } else if (done) {
                    $("body .hint-show,body .mask").fadeIn(300);
                }
            });


            $('#redux').eraser({
                size: 50,
                completeRatio: 0.8,
                completeFunction: showResult
            });
            window.onload = function() {
                if (!logged_in) {
                    $('#redux').css('pointer-events', 'none');
                } else {
                    $(".login-div").hide();
                    $(".logout-div").show();
                }
            };


            function showResult() {
                done = true;
                if (last) {
                    $("#contact-kf-btn").show();
                } else {
                    $("#continue-btn").show();
                }

            }


            $("#continue-btn").click(function() {
                done = false;
                if (!is_demo) {
                    $.post("http://localhost:8888/game/playConfirm");
                }
                getImg();
                var cardST = $('#cardBox').offset().top;
                $(window).scrollTop(cardST);
                $("#continue-btn").hide();
            });


            $("#contact-kf-btn").click(function() {
                if (!is_demo) {
                    $.post("http://localhost:8888/game/playConfirm");
                }
                var serviceST = $('#service').offset().top;
                $(window).scrollTop(serviceST);
            });


            if (logged_in) {
                getImg();
                $(".account").text(account);
                $(".nav").css("display", "flex");
                $('#redux').css('pointer-events', 'auto');
            }



            var num = 0;
            $('.marqueebox li').each(function() {
                $('.num').eq(num).text(num + 1);
                num += 1;
            });


            $('#marquee2').kxbdSuperMarquee({
                isMarquee: true,
                isEqual: false,
                scrollDelay: 20,
                controlBtn: {
                    up: '#goUM',
                    down: '#goDM'
                },
                direction: 'up'
            });



            $('.inquiryLi').click(function() {
                $('body .search-show,body .mask').fadeIn(300);
                $('input[name="cellphone_num2"]').focus();
            });
            $('.cardLi').click(function() {
                var cardST = $('#cardBox').offset().top;
                $(window).scrollTop(cardST);
            });
            $('.serviceLi').click(function() {
                var serviceST = $('#service').offset().top;
                $(window).scrollTop(serviceST);
            });




            $(".mask,.search-show .close").click(function() {
                $(".search-show,.mask").fadeOut(300);
            });
            $(".mask,.reward-show .close,.reward-show .btn").click(function() {
                $(".reward-show,.mask").fadeOut(300);
            });

            new Clipboard("#copy");



            $('.list .title li').click(function() {
                $('.title li').removeClass('active');
                $(this).addClass('active');
                var blockNum = $(this).attr('data-id') - 1;
                $('.list .boxs .allbox').hide();
                $('.list .boxs .allbox').eq(blockNum).show();
            });


            $("#my-records").click(function() {
                if (ajax_sent) {
                    return;
                }

                if (!logged_in) {
                    return;
                }

                $.ajax({
                    url: "http://localhost:8888/game/myRecords",
                    type: "post",
                    dataType: "json",
                    success: function(res) {
                        if (res.error == "000") {
                            var table =
                                '<table>' +
                                '<tr class="tableTitle">' +
                                '<td>奖项</td>' +
                                '<td>中奖时间</td>' +
                                '<td>是否派送</td>' +
                                '</tr>';
                            for (var i = 0; i < res.data.length; i++) {
                                table +=
                                    '<tr>' +
                                    '<td>' + res.data[i].name + '</td>' +
                                    '<td>' + res.data[i].created_at + '</td>' +
                                    '<td>' + (res.data[i].issued ? '是' : '') + '</td>' +
                                    '</tr>';
                            }
                            table += '</table>';
                            $("#reward").html(table);
                        } else if (res.msg) {
                            alert(res.msg);
                        } else {
                            alert("发生未知的错误");
                        }
                    }
                });
            });
        });
    </script>

</body>

</html>